<!DOCTYPE html>
<html>

  <head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  </head>
  <body>
    <button onclick="getLocation()">Try It</button>

    <p id="demo"></p>
    <div style="width: 400px; height: 400px" id="m">

    </div>


    <script>
        var x = document.getElementById("demo");
        var locality = "";
        var country = "";

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            x.innerHTML = "Latitude: " + position.coords.latitude +
            "<br>Longitude: " + position.coords.longitude;
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            printAddress(lat, lng);
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred."
                    break;
            }
        }

        function printAddress(lat, lng){

          var geocoder = new google.maps.Geocoder();
          var location = new google.maps.LatLng(lat, lng);

            // find out info about the location

            geocoder.geocode({location }, function (results, status) {

            if(status == google.maps.GeocoderStatus.OK) {

              if(results[0]) {
                for (i = 0; i< results[0]["address_components"].length; i++){
                  //console.log(results[0]["address_components"][i]);
                  if (results[0]["address_components"][i]["types"].indexOf("locality") > -1){
                    locality = results[0]["address_components"][i]["long_name"]
                  }
                  if (results[0]["address_components"][i]["types"].indexOf("country") > -1){
                    country = results[0]["address_components"][i]["long_name"]
                  }
                }
                //address = results[1].formatted_address;
                //window.alert(address);

                $.ajax({
                  url: "<%= user_profiles_path %>",
                  data: {city: locality, country: country}
                });
              } else {
                error('Google did not return any results.');
              }
            } else {
              error("Reverse Geocoding failed due to: " + status);
            }
          });
        }

      /*  function convert_LatLng_To_Address(lat, lng, callback){
          var url = "http://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat +","+ lng + "&sensor=true";
          jQuery.getJSON(url, function(json){
            create_Address(json, callback);
          });
        }

        function create_Address(json, callback){
          if(!check_status(json))
            return 0;
          address['country'] = google_getCountry(json);
          address['province'] = google_getProvince(json);
          address['city'] = google_getCity(json);
          callback();
        }

        function check_status(json){
          if(json["status"]=="OK") return true;
          return false;
        }*/
    </script>



  </body>
</html>
